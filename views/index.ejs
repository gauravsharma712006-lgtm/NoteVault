<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task Manager</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* --- Base reset & font --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html,body { height: 100%; }
    body {
      background-color: #0b0b0c;
      color: #fff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      overflow-x: hidden;
      position: relative;
    }

    /* --- Background / theme elements (kept from your theme) --- */
    .bg-gradient {
      position: fixed; inset:0;
      background: linear-gradient(180deg,#000000 0%,#0a0a0a 40%,#1a1a1a 70%,#2d1b4e 100%);
      background-size:100% 200%;
      animation: gradient-move 15s ease infinite;
      z-index: -4;
    }
    @keyframes gradient-move { 0%,100%{background-position:0 0} 50%{background-position:0 100%} }

    .orb { position:absolute; border-radius:50%; filter:blur(60px); opacity:.28; animation: float 20s ease-in-out infinite; z-index:-3; pointer-events:none; }
    .orb-1{ width:420px; height:420px; background:linear-gradient(45deg,#1e3a8a,#4c1d95); top:-120px; left:-120px;}
    .orb-2{ width:360px; height:360px; background:linear-gradient(135deg,#1e3a8a,#4c1d95); bottom:-120px; right:-120px; animation-delay:3s;}
    .orb-3{ width:320px; height:320px; background:linear-gradient(225deg,#581c87,#701a75); top:50%; left:50%; transform:translate(-50%,-50%); animation-delay:6s;}
    @keyframes float { 0%,100%{transform:translate(0,0) scale(1)} 33%{transform:translate(30px,-50px) scale(1.06)} 66%{transform:translate(-30px,30px) scale(.96)} }

    .bottom-gradient{ position:fixed; left:0; right:0; bottom:0; height:38%; background:linear-gradient(0deg, rgba(88,28,135,0.36), rgba(76,29,149,0.28), rgba(30,58,138,0.18), transparent); z-index:-2; animation: wave-rise 8s ease-in-out infinite; }
    @keyframes wave-rise { 0%,100%{transform:translateY(10%); opacity:.42} 50%{transform:translateY(-5%); opacity:.64} }

    .grid-pattern{ position: fixed; inset:0; background-image: linear-gradient(rgba(30,30,30,.45) 1px, transparent 1px), linear-gradient(90deg, rgba(30,30,30,.45) 1px, transparent 1px); background-size:48px 48px; z-index:-1; animation: grid-move 20s linear infinite; }
    @keyframes grid-move { 0%{transform:translate(0,0)} 100%{transform:translate(48px,48px)} }

    /* --- Form / controls --- */
    .form-enter { animation: slideUp 0.9s cubic-bezier(.16,1,.3,1) forwards; }
    @keyframes slideUp { from { opacity:0; transform:translateY(30px) } to { opacity:1; transform:translateY(0) } }

    .input-glow { position: relative; transition: transform .28s ease; will-change: transform; }
    .input-glow::before { content:''; position:absolute; inset:-2px; border-radius:.75rem; background: linear-gradient(45deg,#c0c0c0,#e5e5e5,#a8a8a8,#c0c0c0); background-size:300% 300%; opacity:0; z-index:-1; transition:opacity .28s ease; animation: gradient-shift 3s ease infinite; }
    .input-glow:hover::before, .input-glow:focus-within::before { opacity:.7; }
    .input-glow:hover { transform: scale(1.01); }
    .input-glow:focus-within { transform: scale(1.02); }
    @keyframes gradient-shift { 0%,100%{ background-position:0% 50% } 50%{ background-position:100% 50% } }

    .btn-shine { position: relative; overflow:hidden; }
    .btn-shine::before { content:''; position:absolute; top:0; left:-120%; width:120%; height:100%; background:linear-gradient(90deg, transparent, rgba(192,192,192,.38), transparent); transform:skewX(-12deg); transition:left .5s ease; }
    .btn-shine:hover::before { left: 120% }
    .btn-shine::after { content:''; position:absolute; inset:-2px; border-radius:.75rem; background: linear-gradient(45deg,#c0c0c0,#e5e5e5,#a8a8a8,#c0c0c0); background-size:300% 300%; opacity:0; transition:opacity .3s ease; z-index:-1; animation: gradient-shift 3s ease infinite; }
    .btn-shine:hover::after { opacity:.6; }

    /* --- Loader --- */
    .overlay-center { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; background-color: rgba(0,0,0,.6); backdrop-filter: blur(12px); z-index:999; }
    .hidden { display:none; }
    .loader-wrapper { position:relative; width:160px; height:160px; display:flex; align-items:center; justify-content:center; color:#e5e7eb; border-radius:50%; }
    .loader { position:absolute; top:0; left:0; width:100%; aspect-ratio:1/1; border-radius:50%; animation: loader-rotate 2s linear infinite; z-index:0; }
    @keyframes loader-rotate { 0%{ transform:rotate(90deg); box-shadow: 0 10px 20px 0 #3f3f46 inset,0 20px 30px 0 #27272a inset,0 60px 60px 0 #18181b inset } 50%{ transform:rotate(270deg); box-shadow: 0 10px 20px 0 #3f3f46 inset,0 20px 10px 0 #52525b inset,0 40px 60px 0 #09090b inset } 100%{ transform:rotate(450deg); box-shadow: 0 10px 20px 0 #3f3f46 inset,0 20px 30px 0 #27272a inset,0 60px 60px 0 #18181b inset } }

    /* --- Note card: hover effect (lift, glow) --- */
    .task {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      transition: transform 220ms cubic-bezier(.2,.9,.2,1), box-shadow 220ms ease, border-color 220ms ease;
      transform-origin: center;
      will-change: transform;
      border-radius: 1rem;
      border: 1px solid rgba(124,58,237,0.08);
      /* preserve 3D context for child transforms */
      transform-style: preserve-3d;
      perspective: 1000px; /* perspective for nicer 3D */
      -webkit-tap-highlight-color: transparent;
    }
    .task:hover {
      transform: translateY(-8px) scale(1.01);
      box-shadow: 0 10px 30px rgba(10,10,10,.6), 0 2px 8px rgba(124,58,237,0.08);
      border-color: rgba(124,58,237,.18);
    }
    @media (max-width:640px) {
      .task:hover { transform: translateY(-4px) scale(1.0); box-shadow: 0 6px 16px rgba(10,10,10,.5); }
    }

    /* --- 3D flip animation for the whole card --- */
    /* This rotates the whole .task element around Y axis for 1.5s */
    @keyframes card-flip-3d {
      0%   { transform: rotateY(0deg); }
      25%  { transform: rotateY(90deg); }   /* halfway to hide face */
      75%  { transform: rotateY(270deg); }  /* continue rotation */
      100% { transform: rotateY(360deg); }  /* settle back to 0 (visually same orientation) */
    }

    .flip-once {
      animation: card-flip-3d 1500ms cubic-bezier(.2,.9,.2,1) both;
      transform-style: preserve-3d;
      backface-visibility: hidden;
      will-change: transform;
      /* make sure during animation pointer events don't cause more triggers */
      pointer-events: none;
    }

    /* If you prefer a 180deg flip (front/back), replace keyframes above and change to rotateY(180deg) */
    /* Respect user's reduced motion setting â€” don't animate if they prefer reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .flip-once { animation: none !important; pointer-events: auto; }
      .task:hover { transition: none !important; transform: none !important; box-shadow: none !important; }
      .bg-gradient, .orb, .grid-pattern { animation: none !important; }
    }

    /* --- Utilities --- */
    .truncate-2 { display:-webkit-box;-webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .note-action { display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .6rem; border-radius:.5rem; transition: transform 180ms ease, background-color 180ms ease, color 180ms ease; font-size:.9rem; }
    .note-action:active { transform: scale(.98); }
    .note-action.read:hover { color:#bfdbfe; }
    .note-action.edit:hover { color:#fde68a; }
    .note-action.delete:hover { color:#fecaca; }
  </style>
</head>
<body class="bg-zinc-900 text-white">

  <!-- background visuals -->
  <div class="bg-gradient" aria-hidden="true"></div>
  <div class="bottom-gradient" aria-hidden="true"></div>
  <div class="orb orb-1" aria-hidden="true"></div>
  <div class="orb orb-2" aria-hidden="true"></div>
  <div class="orb orb-3" aria-hidden="true"></div>
  <div class="grid-pattern" aria-hidden="true"></div>

  <!-- loader -->
  <div id="loader" class="overlay-center hidden" role="status" aria-live="polite">
    <div class="loader-wrapper">
      <span class="loader-letter" style="--i:1">C</span>
      <span class="loader-letter" style="--i:2">r</span>
      <span class="loader-letter" style="--i:3">e</span>
      <span class="loader-letter" style="--i:4">a</span>
      <span class="loader-letter" style="--i:5">t</span>
      <span class="loader-letter" style="--i:6">i</span>
      <span class="loader-letter" style="--i:7">n</span>
      <span class="loader-letter" style="--i:8">g</span>
      <div class="loader" aria-hidden="true"></div>
    </div>
  </div>

  <!-- header (Logout -> /logout) -->
  <header class="w-full absolute top-4 left-0 z-40 px-4 md:px-10">
  <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">

    <!-- Greeting -->
    <h2 class="text-zinc-300 text-xl font-semibold">
      Hello, <%= user.username %> ðŸ‘‹
    </h2>

    <!-- Logout button -->
    <div class="flex items-center gap-3">
      <a href="/logout"
         class="btn-shine inline-block px-4 py-2 rounded-lg bg-gradient-to-r from-zinc-800 to-zinc-900 border border-zinc-700 text-sm font-medium shadow-md hover:scale-[1.02] transition"
         aria-label="Logout">
        Logout
      </a>
    </div>

  </div>
</header>


  <!-- main -->
  <main class="w-full min-h-screen flex items-start md:items-center justify-center py-20 md:py-28 px-4 md:px-10">
    <div class="w-full max-w-6xl">

      <!-- create form -->
      <div class="mx-auto mb-8 max-w-lg form-enter">
        <div id="formBox" class="p-8 rounded-3xl bg-black/40 backdrop-blur-2xl shadow-2xl border border-zinc-800/50 relative overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-br from-white/5 via-transparent to-transparent pointer-events-none rounded-3xl"></div>

          <h1 class="text-3xl md:text-4xl font-bold text-center mb-2 title-shimmer">Create Task</h1>
          <p class="text-center text-zinc-500 mb-6">Write a quick note â€” responsive & mobile-friendly</p>

          <form id="createForm" action="/createNotes" method="post" class="space-y-5" autocomplete="off" novalidate>
            <div class="input-glow">
              <label for="title" class="sr-only">Title</label>
              <input id="title" name="title" type="text" placeholder="Title goes here"
                class="w-full px-5 py-4 rounded-xl bg-black/60 border border-zinc-800 focus:border-zinc-600 outline-none transition text-zinc-300 placeholder-zinc-600"
                required />
            </div>

            <div class="input-glow">
              <label for="body" class="sr-only">Body</label>
              <textarea id="body" name="body" rows="5" placeholder="Write smarter"
                class="w-full px-5 py-4 rounded-xl bg-black/60 border border-zinc-800 focus:border-zinc-600 outline-none transition text-zinc-300 placeholder-zinc-600 resize-none"
                required></textarea>
            </div>

            <div class="flex flex-col md:flex-row items-center gap-3 md:gap-4">
              <button id="submitBtn" type="button"
                class="btn-shine w-full md:w-auto px-6 py-3 rounded-xl bg-gradient-to-r from-zinc-800 to-zinc-900 border border-zinc-700 font-semibold text-base shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]">
                Create task
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- tasks grid -->
      <section class="tasks grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <% if (files && files.length > 0) { %>
          <% files.forEach(function(val){ %>
            <!-- Note card: .task is the element we flip -->
            <article class="task flex flex-col h-full p-5 bg-zinc-800/70 rounded-2xl shadow-2xl border border-zinc-700/40"
                     data-note-id="<%= val._id %>" aria-live="polite" role="article">
              <h2 class="text-lg md:text-2xl font-semibold mb-3 truncate-2"><%= val.name %></h2>

              <p class="text-zinc-300 text-sm md:text-base mb-4 truncate-2"><%= (val.body && val.body.length>220) ? val.body.substring(0,220) + '...' : (val.body || '') %></p>

              <div class="mt-auto flex items-center justify-between gap-3 pt-4 border-t border-zinc-700/40">
                <a href="/file/<%= val._id %>" class="note-action read text-blue-400 hover:text-blue-300 font-medium text-sm" data-action="read" aria-label="Read <%= val._id %>">Read more</a>

                <div class="flex items-center gap-2">
                  <a href="/edit/<%= val._id %>" class="note-action edit text-zinc-400 hover:text-zinc-200 text-sm" data-action="edit" aria-label="Edit <%= val._id %>">Edit</a>
                  <a href="/delete/<%= val._id%>" class="note-action delete text-zinc-400 hover:text-red-400 text-sm" data-action="delete" aria-label="Delete <%= val._id %>">Delete</a>
                </div>
              </div>
            </article>
          <% }) %>
        <% } else { %>
          <div class="col-span-full text-center py-14">
            <h3 class="text-zinc-500 text-lg">No Tasks Yet. Use the form above to create one!</h3>
          </div>
        <% } %>
      </section>

    </div>
  </main>

  <script>
    // elements
    const createForm = document.getElementById('createForm');
    const submitBtn = document.getElementById('submitBtn');
    const loader = document.getElementById('loader');
    const formBox = document.getElementById('formBox');

    // reset UI when navigating back
    window.addEventListener('pageshow', () => {
      formBox.classList.remove('fade');
      if (loader) loader.classList.add('hidden');
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Create task'; }
    });

    // particle generator (fewer on small screens)
    function createParticle() {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = Math.random() * window.innerWidth + 'px';
      p.style.top = (window.innerHeight + 20) + 'px';
      p.style.animationDelay = Math.random() * 3 + 's';
      p.style.animationDuration = (Math.random() * 3 + 3) + 's';
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 7000);
    }
    const particleInterval = window.innerWidth < 640 ? 900 : 400;
    setInterval(createParticle, particleInterval);

    // form submit handler
    submitBtn.addEventListener('click', () => {
      if (!createForm.reportValidity()) return;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';
      formBox.classList.add('fade');
      loader.classList.remove('hidden');
      setTimeout(() => createForm.submit(), 800);
    });

    // ---------- Flip behavior on note-action click (1.5s) ----------
    // - When a note-action is clicked we:
    //   1) Check prefers-reduced-motion; if reduced, navigate immediately.
    //   2) Prevent default link navigation, add .flip-once class to closest .task.
    //   3) Disable pointer events for the card while flipping.
    //   4) After 1500ms, perform the navigation (or run callback).
    //   5) Remove the class after animationend so it can be re-triggered.
    document.addEventListener('click', function (e) {
      const action = e.target.closest('.note-action');
      if (!action) return;

      const taskCard = action.closest('.task');
      if (!taskCard) return;

      // If user prefers reduced motion, skip animation and navigate immediately
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const href = action.getAttribute('href');

      if (prefersReduced) {
        // let the link navigate naturally (no preventDefault)
        return;
      }

      // Prevent immediate navigation to allow animation
      if (href) e.preventDefault();

      // Prevent re-trigger if already animating
      if (taskCard.classList.contains('flip-once')) return;

      // Add flip class and disable pointer events for the card
      taskCard.classList.add('flip-once');

      // Optional: add an aria-live update for screen readers describing the action
      // (not strictly necessary, but can help)
      try {
        taskCard.setAttribute('aria-busy', 'true');
      } catch (err) {}

      // Remove pointer events on the actions inside card to avoid multiple clicks
      const actionsInside = taskCard.querySelectorAll('.note-action');
      actionsInside.forEach(a => a.style.pointerEvents = 'none');

      // After 1500ms (animation length) continue navigation if href present
      const ANIM_MS = 1500;
      setTimeout(() => {
        // restore pointer-events so if navigation is prevented or fails, UI is usable
        actionsInside.forEach(a => a.style.pointerEvents = '');

        // Remove ARIA busy
        try { taskCard.removeAttribute('aria-busy'); } catch (err) {}

        // If this is a normal link, navigate now
        if (href) {
          // If it's an absolute URL, use location.assign; otherwise preserve relative
          window.location = href;
        } else {
          // If the action is not a link (e.g. triggers JS), you can call the intended handler here.
          // For example, if actions used data-action you can dispatch a custom event:
          const actionType = action.dataset.action;
          if (actionType) {
            taskCard.dispatchEvent(new CustomEvent('noteAction', { detail: { type: actionType, id: taskCard.dataset.noteId } }));
          }
        }
      }, ANIM_MS);

      // Ensure we remove the flip class on animation end, to reset state
      const onAnimEnd = () => {
        try {
          taskCard.classList.remove('flip-once');
          taskCard.removeEventListener('animationend', onAnimEnd);
        } catch (err) {}
      };
      taskCard.addEventListener('animationend', onAnimEnd);
    });

    // accessibility: Ctrl/Cmd + Enter to submit
    document.addEventListener('keydown', function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        submitBtn.click();
      }
    });
  </script>
</body>
</html>
